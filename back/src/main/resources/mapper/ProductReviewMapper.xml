<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.village.revive.mapper.ProductReviewMapper">

    <resultMap id="ProductReviewDTOResultMap" type="com.village.revive.dto.ProductReviewDTO">
        <id column="id" property="id"/>
        <result column="product_id" property="productId"/>
        <result column="user_id" property="userId"/>
        <result column="order_id" property="orderId"/>
        <result column="rating" property="rating"/>
        <result column="content" property="content"/>
        <result column="images" property="images"/>
        <result column="is_anonymous" property="isAnonymous"/>
        <result column="status" property="status"/>
        <result column="reply_content" property="replyContent"/>
        <result column="reply_time" property="replyTime"/>
        <result column="helpful_count" property="helpfulCount"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
        <result column="username" property="username"/>
        <result column="real_name" property="realName"/>
        <result column="user_avatar" property="userAvatar"/>
        <result column="product_name" property="productName"/>
        <result column="product_cover_image" property="productCoverImage"/>
        <result column="status_desc" property="statusDesc"/>
        <result column="is_helpful" property="isHelpful"/>
    </resultMap>

    <!-- 分页查询评价列表 -->
    <select id="selectReviewPage" resultMap="ProductReviewDTOResultMap">
        SELECT 
            r.id,
            r.product_id,
            r.user_id,
            r.order_id,
            r.rating,
            r.content,
            r.images,
            r.is_anonymous,
            r.status,
            r.reply_content,
            r.reply_time,
            r.helpful_count,
            r.created_at,
            r.updated_at,
            CASE 
                WHEN r.is_anonymous = 1 THEN '匿名用户'
                ELSE COALESCE(u.real_name, u.username)
            END as username,
            u.real_name,
            CASE 
                WHEN r.is_anonymous = 1 THEN '/default-avatar.png'
                ELSE u.avatar
            END as user_avatar,
            p.name as product_name,
            p.cover_image as product_cover_image,
            CASE r.status
                WHEN 0 THEN '待审核'
                WHEN 1 THEN '已通过'
                WHEN 2 THEN '已拒绝'
                ELSE '未知'
            END as status_desc,
            CASE 
                WHEN #{currentUserId} IS NULL THEN 0
                WHEN rh.id IS NOT NULL THEN 1
                ELSE 0
            END as is_helpful
        FROM product_reviews r
        LEFT JOIN users u ON r.user_id = u.id
        LEFT JOIN products p ON r.product_id = p.id
        LEFT JOIN review_helpful rh ON r.id = rh.review_id AND rh.user_id = #{currentUserId}
        <where>
            r.deleted = 0
            <if test="query.productId != null">
                AND r.product_id = #{query.productId}
            </if>
            <if test="query.userId != null">
                AND r.user_id = #{query.userId}
            </if>
            <if test="query.rating != null">
                AND r.rating = #{query.rating}
            </if>
            <if test="query.status != null">
                AND r.status = #{query.status}
            </if>
            <if test="query.hasImages != null and query.hasImages">
                AND r.images IS NOT NULL AND r.images != ''
            </if>
        </where>
        <choose>
            <when test="query.sortBy == 'helpful'">
                ORDER BY r.helpful_count ${query.sortOrder}, r.created_at DESC
            </when>
            <when test="query.sortBy == 'rating'">
                ORDER BY r.rating ${query.sortOrder}, r.created_at DESC
            </when>
            <otherwise>
                ORDER BY r.created_at ${query.sortOrder}
            </otherwise>
        </choose>
    </select>

    <!-- 根据ID查询评价详情 -->
    <select id="selectReviewById" resultMap="ProductReviewDTOResultMap">
        SELECT 
            r.id,
            r.product_id,
            r.user_id,
            r.order_id,
            r.rating,
            r.content,
            r.images,
            r.is_anonymous,
            r.status,
            r.reply_content,
            r.reply_time,
            r.helpful_count,
            r.created_at,
            r.updated_at,
            CASE 
                WHEN r.is_anonymous = 1 THEN '匿名用户'
                ELSE COALESCE(u.real_name, u.username)
            END as username,
            u.real_name,
            CASE 
                WHEN r.is_anonymous = 1 THEN '/default-avatar.png'
                ELSE u.avatar
            END as user_avatar,
            p.name as product_name,
            p.cover_image as product_cover_image,
            CASE r.status
                WHEN 0 THEN '待审核'
                WHEN 1 THEN '已通过'
                WHEN 2 THEN '已拒绝'
                ELSE '未知'
            END as status_desc,
            CASE 
                WHEN #{currentUserId} IS NULL THEN 0
                WHEN rh.id IS NOT NULL THEN 1
                ELSE 0
            END as is_helpful
        FROM product_reviews r
        LEFT JOIN users u ON r.user_id = u.id
        LEFT JOIN products p ON r.product_id = p.id
        LEFT JOIN review_helpful rh ON r.id = rh.review_id AND rh.user_id = #{currentUserId}
        WHERE r.id = #{id} AND r.deleted = 0
    </select>

    <!-- 查询商品评价统计信息 -->
    <select id="selectReviewStats" resultType="map">
        SELECT 
            COUNT(*) as total_count,
            COALESCE(AVG(rating), 0) as avg_rating,
            COUNT(CASE WHEN rating = 5 THEN 1 END) as five_star_count,
            COUNT(CASE WHEN rating = 4 THEN 1 END) as four_star_count,
            COUNT(CASE WHEN rating = 3 THEN 1 END) as three_star_count,
            COUNT(CASE WHEN rating = 2 THEN 1 END) as two_star_count,
            COUNT(CASE WHEN rating = 1 THEN 1 END) as one_star_count,
            COUNT(CASE WHEN images IS NOT NULL AND images != '' THEN 1 END) as has_images_count
        FROM product_reviews 
        WHERE product_id = #{productId} AND status = 1 AND deleted = 0
    </select>

    <!-- 查询用户是否已评价某商品 -->
    <select id="checkUserReviewed" resultType="integer">
        SELECT COUNT(*) 
        FROM product_reviews 
        WHERE user_id = #{userId} 
        AND product_id = #{productId}
        <if test="orderId != null">
            AND order_id = #{orderId}
        </if>
        AND deleted = 0
    </select>

    <!-- 更新评价有用数 -->
    <update id="updateHelpfulCount">
        UPDATE product_reviews 
        SET helpful_count = helpful_count + #{increment}
        WHERE id = #{reviewId}
    </update>

    <!-- 查询商品的评价分布 -->
    <select id="selectRatingDistribution" resultType="map">
        SELECT 
            rating,
            COUNT(*) as count,
            ROUND(COUNT(*) * 100.0 / (SELECT COUNT(*) FROM product_reviews WHERE product_id = #{productId} AND status = 1 AND deleted = 0), 2) as percentage
        FROM product_reviews 
        WHERE product_id = #{productId} AND status = 1 AND deleted = 0
        GROUP BY rating
        ORDER BY rating DESC
    </select>

</mapper>
