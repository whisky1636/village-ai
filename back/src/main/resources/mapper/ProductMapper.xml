<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.village.revive.mapper.ProductMapper">

    <!-- 分页查询商品列表 -->
    <select id="selectProductPage" resultType="com.village.revive.dto.ProductDTO">
        SELECT p.*, c.name AS categoryName FROM products p LEFT JOIN product_categories c ON p.category_id = c.id
        <where> <if test="categoryId != null">
       AND p.category_id = #{categoryId}
        </if> <if test="keyword != null and keyword != ''"> AND p.name LIKE CONCAT('%', #{keyword}, '%') </if>
          <if test="status != null">AND p.status = #{status} </if>
        <if test="isFeatured != null">AND p.is_featured = #{isFeatured} </if>
        </where>
        ORDER BY sort_order ASC, created_at DESC
    </select>

    <!-- 获取推荐商品列表 -->
    <select id="selectFeaturedProducts" resultType="com.village.revive.entity.Product">
        SELECT * FROM products 
        WHERE deleted = 0 AND status = 1 AND is_featured = 1
        ORDER BY sort_order ASC, created_at DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- 获取热销商品列表 -->
    <select id="selectHotProducts" resultType="com.village.revive.entity.Product">
        SELECT * FROM products 
        WHERE deleted = 0 AND status = 1
        ORDER BY sales_count DESC, rating DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- 根据分类ID查询商品列表 -->
    <select id="selectByCategoryId" resultType="com.village.revive.entity.Product">
        SELECT * FROM products 
        WHERE deleted = 0 AND status = 1 AND category_id = #{categoryId}
        ORDER BY sort_order ASC, created_at DESC
    </select>

    <!-- 更新库存数量 -->
    <update id="updateStock">
        UPDATE products 
        SET stock = stock + #{quantity}
        WHERE id = #{productId} AND stock + #{quantity} >= 0
    </update>

    <!-- 增加销量 -->
    <update id="incrementSalesCount">
        UPDATE products 
        SET sales_count = sales_count + #{quantity}
        WHERE id = #{productId}
    </update>

</mapper>
