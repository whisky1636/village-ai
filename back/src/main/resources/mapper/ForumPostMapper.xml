<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.village.revive.mapper.ForumPostMapper">
    
    <!-- 结果映射 -->
    <resultMap id="ForumPostDTOMap" type="com.village.revive.dto.ForumPostDTO">
        <id column="id" property="id"/>
        <result column="title" property="title"/>
        <result column="content" property="content"/>
        <result column="category" property="category"/>
        <result column="images" property="images"/>
        <result column="user_id" property="userId"/>
        <result column="status" property="status"/>
        <result column="is_top" property="isTop"/>
        <result column="is_featured" property="isFeatured"/>
        <result column="view_count" property="viewCount"/>
        <result column="like_count" property="likeCount"/>
        <result column="comment_count" property="commentCount"/>
        <result column="admin_reply" property="adminReply"/>
        <result column="admin_reply_time" property="adminReplyTime"/>
        <result column="reject_reason" property="rejectReason"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
        <result column="username" property="username"/>
        <result column="real_name" property="realName"/>
        <result column="user_avatar" property="userAvatar"/>
        <result column="status_desc" property="statusDesc"/>
        <result column="category_desc" property="categoryDesc"/>
        <result column="is_liked" property="isLiked"/>
    </resultMap>

    <!-- 基础查询字段 -->
    <sql id="BaseColumns">
        fp.id, fp.title, fp.content, fp.category, fp.images, fp.user_id, fp.status,
        fp.is_top, fp.is_featured, fp.view_count, fp.like_count, fp.comment_count,
        fp.admin_reply, fp.admin_reply_time, fp.reject_reason, fp.created_at, fp.updated_at,
        u.username, u.real_name, u.avatar as user_avatar
    </sql>

    <!-- 状态描述映射 -->
    <sql id="StatusDesc">
        CASE fp.status
            WHEN 0 THEN '待审核'
            WHEN 1 THEN '已通过'
            WHEN 2 THEN '已拒绝'
            ELSE '未知'
        END as status_desc
    </sql>

    <!-- 分类描述映射 -->
    <sql id="CategoryDesc">
        CASE fp.category
            WHEN 'environment' THEN '环境问题'
            WHEN 'infrastructure' THEN '基础设施'
            WHEN 'agriculture' THEN '农业发展'
            WHEN 'tourism' THEN '旅游发展'
            WHEN 'education' THEN '教育文化'
            WHEN 'other' THEN '其他'
            ELSE fp.category
        END as category_desc
    </sql>

    <!-- 点赞状态 -->
    <sql id="LikedStatus">
        CASE WHEN fpl.id IS NOT NULL THEN 1 ELSE 0 END as is_liked
    </sql>

    <!-- 查询条件 -->
    <sql id="QueryConditions">
        <where>
            <if test="query.keyword != null and query.keyword != ''">
                (fp.title LIKE CONCAT('%', #{query.keyword}, '%') 
                     OR fp.content LIKE CONCAT('%', #{query.keyword}, '%'))
            </if>
            <if test="query.category != null and query.category != ''">
                AND fp.category = #{query.category}
            </if>
            <if test="query.status != null">
                AND fp.status = #{query.status}
            </if>
            <if test="query.userId != null">
                AND fp.user_id = #{query.userId}
            </if>
            <if test="query.isTop != null">
                AND fp.is_top = #{query.isTop}
            </if>
            <if test="query.isFeatured != null">
                AND fp.is_featured = #{query.isFeatured}
            </if>
        </where>
    </sql>

    <!-- 排序条件 -->
    <sql id="OrderBy">
        ORDER BY
        <choose>
            <when test="query.sortField == 'view_count'">
                fp.view_count
            </when>
            <when test="query.sortField == 'like_count'">
                fp.like_count
            </when>
            <when test="query.sortField == 'comment_count'">
                fp.comment_count
            </when>
            <otherwise>
                fp.created_at
            </otherwise>
        </choose>
        <choose>
            <when test="query.sortOrder == 'asc'">
                ASC
            </when>
            <otherwise>
                DESC
            </otherwise>
        </choose>
    </sql>

    <!-- 分页查询帖子列表 -->
    <select id="selectPostsWithUserInfo" resultMap="ForumPostDTOMap">
        SELECT
        <include refid="BaseColumns"/>,
        <include refid="StatusDesc"/>,
        <include refid="CategoryDesc"/>,
        <include refid="LikedStatus"/>
        FROM forum_posts fp
        LEFT JOIN users u ON fp.user_id = u.id
        LEFT JOIN forum_post_likes fpl ON fp.id = fpl.post_id AND fpl.user_id = #{currentUserId}
        <include refid="QueryConditions"/>
        <include refid="OrderBy"/>
    </select>

    <!-- 根据ID查询帖子详情 -->
    <select id="selectPostWithUserInfoById" resultMap="ForumPostDTOMap">
        SELECT
        <include refid="BaseColumns"/>,
        <include refid="StatusDesc"/>,
        <include refid="CategoryDesc"/>,
        <include refid="LikedStatus"/>
        FROM forum_posts fp
        LEFT JOIN users u ON fp.user_id = u.id
        LEFT JOIN forum_post_likes fpl ON fp.id = fpl.post_id AND fpl.user_id = #{currentUserId}
        WHERE fp.id = #{id}
    </select>

    <!-- 分页查询当前用户的帖子列表 -->
    <select id="selectUserPostsWithUserInfo" resultMap="ForumPostDTOMap">
        SELECT
        <include refid="BaseColumns"/>,
        <include refid="StatusDesc"/>,
        <include refid="CategoryDesc"/>,
        <include refid="LikedStatus"/>
        FROM forum_posts fp
        LEFT JOIN users u ON fp.user_id = u.id
        LEFT JOIN forum_post_likes fpl ON fp.id = fpl.post_id AND fpl.user_id = #{currentUserId}
        WHERE fp.user_id = #{currentUserId}
        <if test="query.keyword != null and query.keyword != ''">
            AND fp.title LIKE CONCAT('%', #{query.keyword}, '%')
        </if>
        <if test="query.category != null and query.category != ''">
            AND fp.category = #{query.category}
        </if>
        <if test="query.status != null">
            AND fp.status = #{query.status}
        </if>
        ORDER BY fp.created_at DESC
    </select>

    <!-- 增加浏览次数 -->
    <update id="incrementViewCount">
        UPDATE forum_posts 
        SET view_count = view_count + 1 
        WHERE id = #{id}
    </update>

    <!-- 更新点赞数 -->
    <update id="updateLikeCount">
        UPDATE forum_posts 
        SET like_count = like_count + #{count} 
        WHERE id = #{id}
    </update>

    <!-- 更新评论数 -->
    <update id="updateCommentCount">
        UPDATE forum_posts 
        SET comment_count = comment_count + #{count} 
        WHERE id = #{id}
    </update>

    <!-- 重新计算并更新帖子的评论数 -->
    <update id="recalculateCommentCount">
        UPDATE forum_posts fp
        SET comment_count = (
            SELECT COUNT(*)
            FROM forum_comments fc
            WHERE fc.post_id = fp.id AND fc.status = 1
        )
        WHERE fp.id = #{postId}
    </update>

    <!-- 获取分类统计 -->
    <select id="getCategoryStatistics" resultType="com.village.revive.dto.ForumStatisticsDTO$CategoryStatistics">
        SELECT 
            category,
            CASE category
                WHEN 'environment' THEN '环境问题'
                WHEN 'infrastructure' THEN '基础设施'
                WHEN 'agriculture' THEN '农业发展'
                WHEN 'tourism' THEN '旅游发展'
                WHEN 'education' THEN '教育文化'
                WHEN 'other' THEN '其他'
                ELSE category
            END as categoryDesc,
            COUNT(*) as count,
            ROUND(COUNT(*) * 100.0 / (SELECT COUNT(*) FROM forum_posts), 2) as percentage
        FROM forum_posts 
        GROUP BY category
        ORDER BY count DESC
    </select>

    <!-- 获取状态统计 -->
    <select id="getStatusStatistics" resultType="map">
        SELECT 
            'total' as status_type, COUNT(*) as count
        FROM forum_posts 
        UNION ALL
        SELECT 
            'pending' as status_type, COUNT(*) as count
        FROM forum_posts 
        WHERE status = 0
        UNION ALL
        SELECT 
            'approved' as status_type, COUNT(*) as count
        FROM forum_posts 
        WHERE status = 1
        UNION ALL
        SELECT 
            'rejected' as status_type, COUNT(*) as count
        FROM forum_posts 
        WHERE status = 2
    </select>

    <!-- 获取热门帖子 -->
    <select id="getHotPosts" resultMap="ForumPostDTOMap">
        SELECT
        <include refid="BaseColumns"/>,
        <include refid="StatusDesc"/>,
        <include refid="CategoryDesc"/>,
        <include refid="LikedStatus"/>
        FROM forum_posts fp
        LEFT JOIN users u ON fp.user_id = u.id
        LEFT JOIN forum_post_likes fpl ON fp.id = fpl.post_id AND fpl.user_id = #{currentUserId}
        WHERE fp.status = 1
        ORDER BY fp.like_count DESC, fp.view_count DESC
        LIMIT #{limit}
    </select>

    <!-- 获取最新帖子 -->
    <select id="getLatestPosts" resultMap="ForumPostDTOMap">
        SELECT
        <include refid="BaseColumns"/>,
        <include refid="StatusDesc"/>,
        <include refid="CategoryDesc"/>,
        <include refid="LikedStatus"/>
        FROM forum_posts fp
        LEFT JOIN users u ON fp.user_id = u.id
        LEFT JOIN forum_post_likes fpl ON fp.id = fpl.post_id AND fpl.user_id = #{currentUserId}
        WHERE fp.status = 1
        ORDER BY fp.created_at DESC
        LIMIT #{limit}
    </select>

    <!-- 获取月度统计数据 -->
    <select id="getMonthlyStatistics" resultType="com.village.revive.dto.ForumStatisticsDTO$MonthlyStatistics">
        SELECT 
            DATE_FORMAT(fp.created_at, '%Y-%m') as month,
            COUNT(fp.id) as postCount,
            COALESCE(MAX(fc.comment_count), 0) as commentCount
        FROM forum_posts fp
        LEFT JOIN (
            SELECT 
                DATE_FORMAT(created_at, '%Y-%m') as month,
                COUNT(*) as comment_count
            FROM forum_comments 
            WHERE created_at >= DATE_SUB(NOW(), INTERVAL #{months} MONTH)
            GROUP BY DATE_FORMAT(created_at, '%Y-%m')
        ) fc ON DATE_FORMAT(fp.created_at, '%Y-%m') = fc.month
        WHERE fp.created_at >= DATE_SUB(NOW(), INTERVAL #{months} MONTH)
        GROUP BY DATE_FORMAT(fp.created_at, '%Y-%m')
        ORDER BY month DESC
    </select>
    
    <!-- 删除帖子相关的点赞记录 -->
    <delete id="deletePostLikes">
        DELETE FROM forum_post_likes WHERE post_id = #{postId}
    </delete>
    
    <!-- 删除帖子相关的评论点赞记录 -->
    <delete id="deletePostCommentLikes">
        DELETE fcl FROM forum_comment_likes fcl 
        INNER JOIN forum_comments fc ON fcl.comment_id = fc.id 
        WHERE fc.post_id = #{postId}
    </delete>
    
    <!-- 删除帖子相关的评论 -->
    <delete id="deletePostComments">
        DELETE FROM forum_comments WHERE post_id = #{postId}
    </delete>
    
    <!-- 获取评论总数 -->
    <select id="getTotalCommentsCount" resultType="long">
        SELECT COUNT(*) FROM forum_comments WHERE deleted = 0 AND status = 1
    </select>

    <!-- 强制更新帖子（包括images字段） -->
    <update id="forceUpdatePost">
        UPDATE forum_posts 
        SET 
            title = #{title},
            content = #{content},
            category = #{category},
            images = #{images},
            updated_at = #{updatedAt}
        WHERE id = #{id}
    </update>

</mapper>
